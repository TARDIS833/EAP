# PACK/SET 공통 파서 규칙 스펙

## 1. 전처리 규칙
1. 문자열 공백 정규화: 연속 공백을 1칸으로 치환하고 앞뒤 공백 제거.
2. 구분자 통일: `／`, `| |`, `//` 변형을 `//`로 통일.
3. 선택 토큰 정규화:
- `선택1`, `선택 1`, `선택 1.`, `선택 1:`,`선택 1=`,`선택 1 =` 를 `선택 1`로 통일.
- `상품명. 1{...}` 형태를 `선택 1. 상품명{...}`로 변환.
4. 사은품 토큰 정규화:
- `사은품`, `사은품 증정`, `사은품.`를 `사은품`으로 통일.

## 2. 상품 타입 판별
1. `상품명`에 `PACK` 포함 시 `PACK`.
2. `상품명`에 `[SET]` 또는 `SET` 포함 시 `SET`.
3. `상품명`에 `✖️` 포함 시 미판매 템플릿으로 분류.
- 분석/신규추천 대상에서는 제외.
- 파싱 자체는 가능하게 유지.

## 3. 옵션 토큰 분리
1. 원문 `옵션입력`을 `//` 기준으로 분리.
2. 각 토큰을 아래 3종으로 분류:
- 선택 토큰: `선택 N ...`
- 사은품 토큰: `사은품 ...`
- 기타 토큰: 위 둘 모두 아님(로그/검토용)

## 4. 선택 토큰 파싱
권장 정규식:
- 슬롯 추출: `선택\\s*(\\d+)`
- 품목/값 추출: `선택\\s*\\d+\\s*\\.?\\s*([^\\{:=]+)?\\s*[\\{:=]\\s*(.+)`

해석 규칙:
1. 슬롯 번호 `N` 추출.
2. 품목명(브라/브리프/쇼츠/삭스 등) 추출.
3. 값 블록이 `{a|b|c}`면 `|`로 분해하여 후보값 리스트 구성.
4. 실제 주문 옵션에서 `선택 N`의 선택값을 찾고 매칭.

## 5. 실제 주문 옵션 문자열 파싱
주문 데이터(예: `주문상품명(옵션포함)`)에도 동일한 `선택 N` 파서 적용:
1. `선택 N` 블록 순회.
2. `N -> 선택값` 맵 생성.
3. 템플릿 슬롯 정의와 조인하여 출고행 생성.

## 6. 출고행 생성 규칙
1. 각 슬롯별 prefix 결정:
- 품목명 기반 매핑 테이블(브라/브리프/쇼츠/삭스/타이즈).
2. 선택값을 색상/사이즈로 분해:
- 마지막 토큰을 사이즈(S/M/L/XL/FREE 등)로 우선 인식.
- 나머지 문자열을 색상으로 처리.
3. 출력 포맷:
- `출고명 = {prefix}_{색상}_{사이즈}`
4. 수량:
- 기본 1.
- PACK/SET은 슬롯 수만큼 행 생성.

## 7. 사은품 처리 규칙
1. 사은품 토큰은 메인 슬롯 파싱 전에 먼저 추출.
2. 사은품은 `gift_rules.json` 규칙으로만 생성(사용자 커스텀 규칙과 분리).
3. 예시:
- `기프트박스 (중)` -> `타밈_기프트패키지_중(증정)`
- `[헬씨 브리프 증정]` -> `헬씨P_랜덤_{선택사이즈}(증정)`

## 8. 템플릿 매칭 전략
1. 1차: 완전일치 키(`스토어타입|상품명 정규화`).
2. 2차: 패턴 매칭.
- 접두 태그(`[HOLIDAY]`, `[수미 PICK]`) 제거 후 재시도.
3. 실패 시 `prefix 누락`이 아니라 `템플릿 미정의`로 별도 로그.

## 9. 검증 규칙
1. 슬롯 연속성 검사: `1..N` 누락 여부 확인.
2. 주문 선택값이 템플릿 후보에 없는 경우 경고.
3. 생성 행 수와 기대 슬롯 수 비교.
4. 미매칭 건은 `누락_*.xlsx`에 원문/정규화문 동시 저장.

## 10. 운영 원칙
1. 조합(모든 경우의 수) 저장 금지.
2. 템플릿은 슬롯 구조만 저장.
3. 실제 선택값은 주문 데이터에서 읽어 동적으로 출고행 생성.
