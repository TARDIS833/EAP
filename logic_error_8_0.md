# logic_error_8_0

8_0 실무 이슈의 원인/조치 이력을 누적 기록한다.

## 2026-02-12 버그픽스 (8_1 반영)

### 1) 캐미젤리B의 `[B]` 접두어가 비블랙/비스킨 컬러에도 붙는 문제
- 증상:
  - `변환 완료` 시트에서 `[B]캐미젤리B_내추럴스킨_M`, `[B]캐미젤리B_라벤더포그_S` 등 비블랙/비스킨 컬러에도 `[B]`가 붙음.
- 원인:
  - `configs/excel_auto_mapping.json`의 `SELF_PREFIX_MAP`에서 캐미젤리브라 계열 prefix가 기본 `[B]캐미젤리B`로 매핑되어 있었고,
  - 색상별 조건 분기 없이 그대로 `출고명`을 생성함.
- 조치:
  - 코드에서 `출고명` 후처리 정규화(`normalize_output_name`)를 추가.
  - 규칙: `캐미젤리B`는 색상이 `블랙`, `스킨`일 때만 `[B]` 유지, 그 외 색상은 `[B]` 제거.

### 2) 캐미젤리B 신규컬러에 `_FREE`가 잘못 붙는 문제 (`..._M_FREE`)
- 증상:
  - `변환 완료` 시트 16행 예시: `[B]캐미젤리B_마쉬멜로우핑크_M_FREE`
  - 동일 패턴 다수 재현.
- 원인:
  - 원본 옵션 문자열이 `마쉬멜로우핑크_M` 형태(언더스코어 구분)인데,
  - 기존 `split_color_size`가 공백 기반 분리 위주라 `마쉬멜로우핑크_M`를 단일 토큰으로 처리,
  - 사이즈를 `FREE`로 보정하면서 결과적으로 `색상=마쉬멜로우핑크_M`, `사이즈=FREE`가 되어 `..._M_FREE` 형태가 생성됨.
- 조치:
  - `split_color_size`에 `색상_사이즈` 패턴(`..._(S|M|L|XL|XXL|XS|FREE)`) 우선 파싱 추가.
  - `normalize_output_name`에서 `캐미젤리B`의 잘못된 `*_FREE` 꼬리(`M_FREE/L_FREE/S_FREE`) 제거.

### 3) 캐미포시즌 3PACK에서 로크젤리브라 증정이 2개 생성되는 문제
- 증상:
  - 주문번호 `20260212-0001830`, `20260212-0001949`, `20260212-0002287`에서
  - 로크젤리B 증정이 2줄(예: `로크젤리B_블랙_S(증정)` + `로크젤리B_핑크_S(증정)`) 생성.
- 원인:
  - `gift_rules.json`에 아래 규칙이 동시에 존재:
    - 옵션 기반 규칙: `사은품. 로크젤리브라=...` (실제 주문 옵션 반영)
    - 레거시 상품명 기반 규칙: `캐미포시즌 3PACK 증정(레거시)` (고정 핑크 증정)
  - 동일 주문에 두 규칙이 함께 매칭되어 증정 2개가 생성됨.
- 조치:
  - `gift_rules.json`에서 `캐미포시즌 3PACK 증정(레거시)` 제거.
  - 코드에 방어 로직 추가:
    - option 기반 증정이 존재하면 동일 `output.product`의 product 기반 증정 이벤트는 제거.

### 4) 유사 사례 점검 결과
- 동일 유형으로 확인된 사례:
  - `[B]` 오적용: 캐미젤리B 비블랙/비스킨 컬러 전반
  - `*_FREE` 오적용: 마쉬멜로우핑크 계열 등 언더스코어 사이즈 표기 주문
  - 증정 중복: 캐미포시즌 3PACK 로크젤리브라 증정 주문
- 위 3개 수정으로 동일 패턴 재현 데이터에서 함께 해소됨.

## 재발 방지
- 증정 규칙 신규 추가 시:
  - 상품명 기반(product) 규칙과 옵션 기반(option) 규칙의 중복 매칭 여부를 함께 검증.
- 옵션 파서 수정 시:
  - `색상_사이즈`, `색상 사이즈`, `색상=...; 사이즈=...` 3가지 포맷 회귀 테스트 수행.
- 출고명 후처리:
  - 브랜드/라인별 접두어 특수 규칙(`[B]` 등)을 생성 단계 또는 후처리 단계에서 명시적으로 강제.

## 2026-02-13 버그픽스 (8_1 패치 반영)

### 5) `캐미 젤리브라 2PACK + 캐미 포시즌 젤리브라탑 3PACK`에서 브라탑이 전부 캐미젤리B로 출력되는 문제
- 증상:
  - 예시 주문번호 `20260213-0000521`에서 `캐미포시즌젤리브라탑` 3개가 모두 `[B]캐미젤리B_*`로 합산되어 출력됨.
- 원인:
  - 자사몰 세트 파서(`parse_self_options`)는 `선택 N. <제품명>=<색상 사이즈>`에서 `<제품명>`을 `SELF_SET_PRODUCT_MAP`으로 prefix로 치환한다.
  - `configs/excel_auto_mapping.json`의 `SELF_SET_PRODUCT_MAP`에 `캐미포시즌젤리브라탑` 매핑이 없어서 prefix가 빈 값이 되었고,
  - 후속 처리에서 “전체 상품명 기준 prefix(find_self_prefixes)”의 첫 값을 fallback으로 사용하면서 전부 `[B]캐미젤리B`로 출력됨.
- 조치:
  - `configs/excel_auto_mapping.json`에 아래 매핑을 추가:
    - `SELF_SET_PRODUCT_MAP["캐미포시즌젤리브라탑"] = "캐미포시즌젤리T"`
    - 표기 변형 대비로 `SELF_SET_PRODUCT_MAP["캐미포시즌브라탑"] = "캐미포시즌젤리T"`도 함께 추가
